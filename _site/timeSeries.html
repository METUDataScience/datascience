<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Time Series Analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Introduction to Data Science</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="installation.html">R/RStudio Installation</a>
    </li>
    <li>
      <a href="azure_notebooks.html">Azure Notebooks</a>
    </li>
    <li>
      <a href="intro_to_r.html">Introduction to R</a>
    </li>
    <li>
      <a href="amelia.html">Missing Data Imputation</a>
    </li>
    <li>
      <a href="associationMining.html">Association Mining</a>
    </li>
    <li>
      <a href="classification.html">Classification</a>
    </li>
    <li>
      <a href="regression.html">Regression Analysis</a>
    </li>
    <li>
      <a href="timeSeries.html">Time Series Analysis</a>
    </li>
    <li>
      <a href="visualization.html">Visualization</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://mehmetaliakyol.com">
    <span class="fa fa-question fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Time Series Analysis</h1>

</div>


<p>Time series analysis is concerned with data that is associated with their dates, such as stock prices.</p>
<p>Get and change the data into correct format:</p>
<pre class="r"><code>data(AirPassengers) #Get airpassangers data 
head(AirPassengers)</code></pre>
<pre><code>## [1] 112 118 132 129 121 135</code></pre>
<pre class="r"><code>#install.packages(&quot;tseries&quot;) 
require(tseries)</code></pre>
<div id="model-determination" class="section level2">
<h2>Model Determination</h2>
<p>First we need to determine the characteristics of the data so we can transform and model it appropriately. After transformation (if necessary), we move to decomposing the data. Finally, we model those components.</p>
<pre class="r"><code>plot(AirPassengers)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>As you can see, variance increases with time. This means that data is not stationary.</p>
<p>Let’s perform <code>adf.test</code> to confirm non-stationarity.</p>
<pre class="r"><code>kpss.test(AirPassengers, null = &quot;Level&quot;) #Check for level stationarity</code></pre>
<pre><code>## 
##  KPSS Test for Level Stationarity
## 
## data:  AirPassengers
## KPSS Level = 2.7395, Truncation lag parameter = 4, p-value = 0.01</code></pre>
<pre class="r"><code>kpss.test(AirPassengers, null = &quot;Trend&quot;) #Check for trend stationairty</code></pre>
<pre><code>## 
##  KPSS Test for Trend Stationarity
## 
## data:  AirPassengers
## KPSS Trend = 0.09615, Truncation lag parameter = 4, p-value = 0.1</code></pre>
<pre class="r"><code>adf.test(AirPassengers, alternative = &quot;stationary&quot;, k = 12)</code></pre>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  AirPassengers
## Dickey-Fuller = -1.5094, Lag order = 12, p-value = 0.7807
## alternative hypothesis: stationary</code></pre>
<p>According to <code>kpss.test</code>, the data is not level stationary however it seems to be trend stationary. <code>kpss.test</code> looks for changes in mean throughout the time series, “trend stationary” means, there is a linear trend in the data and when this is subtracted from the time series, the mean is stationary.</p>
<p>In case of a unit root, both the mean and the variance change with time. In this case, our data has non stationary variance and non stationary mean. So the data is non stationary.</p>
<p>To solve the non-stationarity in variance, we can log transform the data and to solve the non-stationarity in mean, we can use differencing.</p>
<pre class="r"><code>AirPas.log &lt;- log(AirPassengers) 
AirPas.logdif &lt;- diff(AirPas.log, lag=1, differences = 1) 
par(mfrow= c(1,2)) 
plot(AirPas.log) 
plot(AirPas.logdif)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>After logging, the variance seems stationary through all seasonal effects. After differencing, mean seems stationary. Some datasets may need higher order differencing to achieve mean stationarity.</p>
<p>Let’s take a look at ACF and PACF.</p>
<pre class="r"><code>par(mfrow=c(1,2)) 
acf(AirPas.logdif, lag.max = 36) 
pacf(AirPas.logdif, lag.max = 36)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Based on the ACF plot, the existence of seasonality is evident. The seasonal lag seems to be 12 months. We could decompose the data to see the seasonal effects.</p>
<pre class="r"><code>decomp &lt;- decompose(AirPas.logdif) #Find seasonal and trend compositions of the data 
par(mfrow=c(1,1)) 
plot(decomp)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>There are clearly some seasonal components in the data. We should adjust for seasonality.</p>
<pre class="r"><code>data &lt;- AirPas.logdif - decomp$seasonal #Remove seasonal effect 
t &lt;- time(data) 
fit &lt;- lm(data~t) #Fit linear regression to the mean 
plot(data, type = &quot;l&quot;) 
abline(fit) #Plot linear regression line</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Let’s check for stationarity:</p>
<pre class="r"><code>kpss.test(data, null = &quot;Level&quot;) #Check for level stationarity</code></pre>
<pre><code>## 
##  KPSS Test for Level Stationarity
## 
## data:  data
## KPSS Level = 0.065265, Truncation lag parameter = 4, p-value = 0.1</code></pre>
<pre class="r"><code>kpss.test(data, null = &quot;Trend&quot;) #Check for trend stationairty</code></pre>
<pre><code>## 
##  KPSS Test for Trend Stationarity
## 
## data:  data
## KPSS Trend = 0.025627, Truncation lag parameter = 4, p-value = 0.1</code></pre>
<pre class="r"><code>adf.test(data, alternative = &quot;stationary&quot;, k = 11)</code></pre>
<pre><code>## 
##  Augmented Dickey-Fuller Test
## 
## data:  data
## Dickey-Fuller = -4.6977, Lag order = 11, p-value = 0.01
## alternative hypothesis: stationary</code></pre>
<p>As you can see, we have a stationary time-series after solving the non-stationary mean, non-stationary variance and seasonality problems. Now we should take a look at the ACF and PACF once again.</p>
<pre class="r"><code>par(mfrow=c(1,2)) 
acf(data, lag.max = 36) 
pacf(data, lag.max = 36)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>There are still some long lag time dependencies in the data but there is no clear seasonality, we could assume that those high values could be due to shocks or random effects. Since we cannot determine if it’s either an AR or a MA process, we should try out different models. Most likely it is an ARMA or an ARIMA process. Let’s recap what we found so far: * Data is non-stationary due to changing mean and variance. We solved this by log-transforming and differencing. Difference order was 1. * Model has a seasonal component with a period of 12.</p>
<p>We will use the log-transformed data to model the time series. We will specify the differencing order in the model. As mentioned before, we should use different models.</p>
<p>Initially I will use an <code>AR(1)-SAR(1)</code> model.</p>
<pre class="r"><code>model &lt;- arima(AirPas.log, order = c(1,1,0), seasonal=list(order = c(1,0,0), period = frequency(AirPas.log))) 
model</code></pre>
<pre><code>## 
## Call:
## arima(x = AirPas.log, order = c(1, 1, 0), seasonal = list(order = c(1, 0, 0), 
##     period = frequency(AirPas.log)))
## 
## Coefficients:
##           ar1    sar1
##       -0.2905  0.9287
## s.e.   0.0822  0.0229
## 
## sigma^2 estimated as 0.001777:  log likelihood = 237.94,  aic = -469.89</code></pre>
<pre class="r"><code>par(mfrow=c(1,1)) 
plot(model$resid, type = &quot;p&quot;) #Residual plot 
abline(0,0)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>When we look at the residuals, we see that residuals have decreasing variance. This means that the residuals are not independent. Model is not appropriate. Normally we want residuals to randomly distributed above and below the (0,0) line. We can use Ljung-Box test to confirm dependency.</p>
<pre class="r"><code>Box.test(model$residuals, lag = 12, type = &quot;Ljung-Box&quot;, fitdf = 1)</code></pre>
<pre><code>## 
##  Box-Ljung test
## 
## data:  model$residuals
## X-squared = 23.178, df = 11, p-value = 0.01668</code></pre>
<p>Null hypothesis of the Ljung-Box test is independence in the time series. In this case, we reject the null-hypothesis, our residuals are not independent. Let’s fit an <code>ARMA(1,1)-SAR(1)</code> model.</p>
<pre class="r"><code>model2 &lt;- arima(AirPas.log, order = c(1,1,1), seasonal=list(order = c(1,0,0), period = frequency(AirPas.log))) 
model2</code></pre>
<pre><code>## 
## Call:
## arima(x = AirPas.log, order = c(1, 1, 1), seasonal = list(order = c(1, 0, 0), 
##     period = frequency(AirPas.log)))
## 
## Coefficients:
##          ar1      ma1    sar1
##       0.4369  -0.7264  0.9204
## s.e.  0.3553   0.2847  0.0295
## 
## sigma^2 estimated as 0.001768:  log likelihood = 238.9,  aic = -469.79</code></pre>
<pre class="r"><code>plot(model2$resid, type = &quot;p&quot;) #Residual plot 
abline(0,0)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>Box.test(model2$residuals, lag = 12, type = &quot;Ljung-Box&quot;, fitdf = 1)</code></pre>
<pre><code>## 
##  Box-Ljung test
## 
## data:  model2$residuals
## X-squared = 20.784, df = 11, p-value = 0.03568</code></pre>
<p>In this case, our p-value increased, but the residuals are still dependent. Let’s fit another model, this time let’s fit a <code>MA(1)-SAR(1)</code> model.</p>
<pre class="r"><code>model3 &lt;- arima(AirPas.log, order = c(0,1,1), seasonal=list(order = c(1,0,0), period = frequency(AirPas.log))) 
model3</code></pre>
<pre><code>## 
## Call:
## arima(x = AirPas.log, order = c(0, 1, 1), seasonal = list(order = c(1, 0, 0), 
##     period = frequency(AirPas.log)))
## 
## Coefficients:
##           ma1    sar1
##       -0.3259  0.9304
## s.e.   0.0924  0.0226
## 
## sigma^2 estimated as 0.001767:  log likelihood = 238.2,  aic = -470.39</code></pre>
<pre class="r"><code>plot(model3$resid, type = &quot;p&quot;) #Residual plot 
abline(0,0)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-22-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>Box.test(model3$residuals, lag = 12, type = &quot;Ljung-Box&quot;, fitdf = 1)</code></pre>
<pre><code>## 
##  Box-Ljung test
## 
## data:  model3$residuals
## X-squared = 22.626, df = 11, p-value = 0.01995</code></pre>
<p>Our p-value decreased again. Instead of trying out a bunch of different models, we can use <code>auto.arima</code> to automatically fit the model.</p>
<pre class="r"><code>#install.packages(&quot;forecast&quot;) 
require(forecast)
model4 &lt;- auto.arima(AirPas.log) 
model4</code></pre>
<pre><code>## Series: AirPas.log 
## ARIMA(0,1,1)(0,1,1)[12] 
## 
## Coefficients:
##           ma1     sma1
##       -0.4018  -0.5569
## s.e.   0.0896   0.0731
## 
## sigma^2 estimated as 0.001371:  log likelihood=244.7
## AIC=-483.4   AICc=-483.21   BIC=-474.77</code></pre>
<pre class="r"><code>plot(model4$resid, type = &quot;p&quot;) #Residual plot 
abline(0,0)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-25-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>Box.test(model4$residuals, lag = 12, type = &quot;Ljung-Box&quot;, fitdf = 1)</code></pre>
<pre><code>## 
##  Box-Ljung test
## 
## data:  model4$residuals
## X-squared = 9.2333, df = 11, p-value = 0.6004</code></pre>
<p><code>auto.arima</code> function fitted an <code>ARIMA(0,1,1)-SARIMA(2,1,2)</code> model to our data. The data had strong seasonal effect. When model selection is performed, we would like the model with the smallest AIC/BIC. Auto-fitted model has the minimum AIC of all presented models. Our residuals are now independent. Let’s look at the ACF and PACF of the residuals to confirm.</p>
<pre class="r"><code>par(mfrow=c(1,2)) 
acf(model4$resid) 
pacf(model4$resid)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>No dependencies left in the residuals. Model is appropriate.</p>
</div>
<div id="forecasting" class="section level2">
<h2>Forecasting</h2>
<p>We can forecast using the forecast function in the <code>forecast</code> package.</p>
<pre class="r"><code>future &lt;- forecast(model4, 12) #Forecast next 12 observations 
plot(future)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-28-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Remember that we took the log transform of our data, so for proper forecasting we need to exponentiate to obtain the real time series and forecasted values.</p>
<pre class="r"><code>future.original &lt;- future #Make a copy of the forecasted values 
future.original$x &lt;- exp(future.original$x) #Exponentiate the original time series 
future.original$mean &lt;- exp(future.original$mean) #Exponentiate the forecasted values 
future.original$lower &lt;- exp(future.original$lower) #Exponentiate lower confidence intervals (80% and 95% confidence) 
future.original$upper &lt;- exp(future.original$upper) #Exponentiate upper confidence intervals (80% and 95% confidence) 
plot(future.original)</code></pre>
<p><img src="timeSeries_files/figure-html/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
